name: test helm release

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  tests:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    - name: Provided necessary things
      run: |
        helm show values k8s/familychart/ > helmvalues.yaml
        mkdir -p tests
        DATE_TMP=$(date +%s)
        echo "DATE=$DATE_TMP" >> $GITHUB_ENV
        
    - name: Run trivy on low,medium high
      run: |
        cat helmvalues.yaml | docker run -i --rm mikefarah/yq e '.installer.image' - | xargs -n1 -I{} \
        docker run --rm \
        -v /var/run/docker.sock:/var/run/docker.sock \
        -v $HOME/Library/Caches:/root/.cache/ \
        -v "$(pwd):/src" \
        aquasec/trivy \
        --exit-code 0 \
        --severity LOW,MEDIUM,HIGH \
        --format template --template "@contrib/junit.tpl" \
        -o src/junit-report-low-med-high_${{ env.DATE }}.xml \
        --ignore-unfixed \
        'luke19/familycluster_installer@{}'
       
    - name: Run trivy on high
      run: |
        cat helmvalues.yaml | docker run -i --rm mikefarah/yq e '.installer.image' - | xargs -n1 -I{} \
        docker run --rm \
        -v /var/run/docker.sock:/var/run/docker.sock \
        -v $HOME/Library/Caches:/root/.cache/ \
        -v "$(pwd):/src" \
        aquasec/trivy \
        --exit-code 0 \
        --severity CRITICAL \
        --format template --template "@contrib/junit.tpl" \
        -o src/junit-report-crit_${{ env.DATE }}.xml \
        --ignore-unfixed \
        'luke19/familycluster_installer@{}'
        
    - name: Move every result in test folder
      run: |
        mv junit-report-low-med-high_${{ env.DATE }}.xml tests/junit-report-low-med-high_${{ env.DATE }}.xml
        mv junit-report-crit_${{ env.DATE }}.xml tests/junit-report-crit_${{ env.DATE }}.xml
        
    - uses: EndBug/add-and-commit@v7
      with:
        message: Add test results
        committer_name: GitHub Actions
        committer_email: actions@github.com
        

